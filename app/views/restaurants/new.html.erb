<div class="max-w-3xl mx-auto">
  <div class="mb-8">
    <h1 class="text-5xl font-black text-black mb-3 tracking-tight">
      <%= current_user.admin? ? "Add New Restaurant" : "Register Your Restaurant" %>
    </h1>
    <p class="text-lg text-gray-600 font-medium">
      <%= current_user.admin? ? "Create a new restaurant and assign it to a user account." : "Complete your restaurant profile to start collecting customer feedback." %>
    </p>
  </div>

  <div class="bg-white border-2 border-black rounded-2xl shadow-[6px_6px_0_0_#000] p-8">
    <%= form_with model: @restaurant, url: restaurants_path, local: true, class: "space-y-6" do |form| %>
      <% if @restaurant.errors.any? || (@user&.errors&.any?) %>
        <div class="bg-red-100 border-2 border-red-300 text-red-800 px-6 py-4 rounded-xl">
          <h3 class="font-bold text-sm uppercase tracking-wide mb-2">Please fix the following errors:</h3>
          <ul class="list-disc list-inside space-y-1 text-sm">
            <% @restaurant.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
            <% if @user&.errors&.any? %>
              <% @user.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if current_user.admin? %>
        <!-- Admin: User Selection/Creation Section -->
        <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-6 mb-6">
          <h3 class="text-lg font-black text-black mb-4 uppercase tracking-wide">User Account</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-black uppercase tracking-wide mb-2">
                Select Existing User <span class="text-gray-500 normal-case">(without a restaurant)</span>
              </label>
              <%= form.select :user_id,
                  options_from_collection_for_select(@restaurant_owners, :id, :email_address, params[:restaurant]&.dig(:user_id)),
                  { include_blank: "Or create a new user account below" },
                  { class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all bg-white",
                    id: "user_select",
                    onchange: "toggleNewUserFields(this.value === '')" } %>
            </div>

            <div class="text-center text-gray-500 font-medium text-sm py-2">OR</div>

            <div id="new_user_fields" class="<%= params[:restaurant]&.dig(:user_id).present? ? 'hidden' : '' %>">
              <h4 class="text-sm font-bold text-black uppercase tracking-wide mb-3">Create New User Account</h4>
              <%= fields_for :user, @user || User.new do |user_form| %>
                <div class="space-y-4">
                  <div>
                    <%= user_form.label :email_address, "Email Address *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
                    <%= user_form.email_field :email_address,
                        class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all",
                        placeholder: "owner@restaurant.com" %>
                  </div>
                  <div class="grid md:grid-cols-2 gap-4">
                    <div>
                      <%= user_form.label :password, "Password *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
                      <%= user_form.password_field :password,
                          class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all",
                          placeholder: "Enter password" %>
                    </div>
                    <div>
                      <%= user_form.label :password_confirmation, "Confirm Password *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
                      <%= user_form.password_field :password_confirmation,
                          class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all",
                          placeholder: "Re-enter password" %>
                    </div>
                  </div>
                  <div class="mt-2.5">
                    <%= render "shared/password_requirements" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Admin: Status Selection -->
        <div class="mb-6">
          <%= form.label :status, "Status *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
          <%= form.select :status,
              [["Pending", "pending"], ["Approved", "approved"]],
              { selected: "approved" },
              { class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all bg-white" } %>
          <p class="text-xs text-gray-600 mt-1">Admins can set the restaurant status directly.</p>
        </div>
      <% end %>

      <div class="grid md:grid-cols-2 gap-6">
        <div class="md:col-span-2">
          <%= form.label :name, "Restaurant Name *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
          <%= form.text_field :name, 
              class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all",
              placeholder: "e.g., The Gourmet Kitchen" %>
        </div>

        <div>
          <%= form.label :owner_name, "Owner Name *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
          <%= form.text_field :owner_name, 
              class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all",
              placeholder: "John Doe" %>
        </div>

        <div>
          <%= form.label :plan, "Plan *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
          <%= form.select :plan, 
              [["Free", "free"], ["Paid", "paid"]], 
              { selected: "free" },
              { class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all bg-white" } %>
        </div>

        <div>
          <%= form.label :email, "Restaurant Email *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
          <%= form.email_field :email, 
              class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all",
              placeholder: "contact@restaurant.com" %>
        </div>

        <div>
          <%= form.label :phone, "Phone Number *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
          <%= form.text_field :phone, 
              class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all",
              placeholder: "+1 234 567 8900" %>
        </div>

        <div class="md:col-span-2">
          <%= form.label :address, "Full Address *", class: "block text-sm font-bold text-black uppercase tracking-wide mb-2" %>
          <%= form.text_area :address, 
              rows: 3,
              class: "w-full px-4 py-3 border-2 border-black rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all resize-none",
              placeholder: "123 Main Street, City, State, ZIP Code" %>
        </div>
      </div>

      <div class="pt-4 border-t-2 border-gray-200 flex items-center justify-between">
        <%= link_to "Cancel", current_user.admin? ? restaurants_path : dashboard_path, class: "text-black font-bold hover:underline transition-all text-sm uppercase tracking-wide" %>
        <%= form.submit current_user.admin? ? "Create Restaurant" : "Register Restaurant", class: "bg-black text-white px-8 py-3.5 rounded-xl hover:bg-gray-900 transition-all duration-200 text-sm font-bold border-2 border-black shadow-[4px_4px_0_0_#000] hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] uppercase tracking-wide cursor-pointer" %>
      </div>
    <% end %>
  </div>

  <% unless current_user.admin? %>
    <div class="mt-6 p-4 bg-gray-50 border-2 border-gray-200 rounded-xl">
      <p class="text-xs text-gray-600 text-center">
        <strong class="text-black">Note:</strong> Your restaurant registration will be reviewed by our admin team. You'll receive an email notification once it's approved.
      </p>
    </div>
  <% end %>
</div>

<% if current_user.admin? %>
  <script>
    function toggleNewUserFields(show) {
      const fields = document.getElementById('new_user_fields');
      if (fields) {
        fields.classList.toggle('hidden', !show);
        // Clear new user fields if selecting existing user
        if (!show) {
          const inputs = fields.querySelectorAll('input');
          inputs.forEach(input => input.value = '');
        }
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      const select = document.getElementById('user_select');
      if (select) {
        toggleNewUserFields(select.value === '');
      }
    });
  </script>
<% end %>

